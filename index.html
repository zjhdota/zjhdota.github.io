<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="your life. your learning. your way.">
<meta property="og:type" content="website">
<meta property="og:title" content="Nameless">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Nameless">
<meta property="og:description" content="your life. your learning. your way.">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nameless">
<meta name="twitter:description" content="your life. your learning. your way.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> Nameless </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Nameless</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">If you want something you've never had, then you've got to do something you've never done.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/14/CentOS7 部署Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/14/CentOS7 部署Redis/" itemprop="url">
                  CentOS7部署Redis
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-14T18:04:57+08:00">
                2018-02-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h1><ul>
<li>CentOS Linux release 7.4.1708 (Core)</li>
</ul>
<h1 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h1><ul>
<li>Redis官网下载网址：<a href="http://redis.io/download" target="_blank" rel="noopener">这里</a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> wget http://download.redis.io/releases/redis-4.0.2.tar.gz</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tar -zxvf redis-4.0.2.tar.gz</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> redis-4.0.2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="配置Redis开机自启"><a href="#配置Redis开机自启" class="headerlink" title="配置Redis开机自启"></a>配置Redis开机自启</h1><ol>
<li><p>修改Redis配置文件，开启守护进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> redis-4.0.2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi redis.conf</span></span><br></pre></td></tr></table></figure>
<p> 将</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">daemonize</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure>
<p> 改为</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">daemonize</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写脚本文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/init.d/redis</span></span><br></pre></td></tr></table></figure>
<p> 尽量手写，内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chkconfig: 2345 10 90</span></span><br><span class="line"><span class="comment"># description: start and stop redis</span></span><br><span class="line"></span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/bin:/sbin/usr/<span class="built_in">local</span>/bin:/bin</span><br><span class="line"></span><br><span class="line">REDISPORT=6379 <span class="comment"># redis端口号</span></span><br><span class="line"></span><br><span class="line">EXEC=/usr/<span class="built_in">local</span>/bin/redis-server </span><br><span class="line">REDIS_CLI=/usr/<span class="built_in">local</span>/bin/redis-cli</span><br><span class="line">PIDFILE=/var/run/redis_6379.pid <span class="comment">#redis pid绝对路径(默认路径)</span></span><br><span class="line">CONF=<span class="string">"/usr/local/redis/redis.conf"</span> <span class="comment"># redis配置文件绝对路径</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="variable">$PIDFILE</span> ]</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"<span class="variable">$PIDFILE</span> exists, process is already running or crashed."</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"starting redis server..."</span></span><br><span class="line">                <span class="variable">$EXEC</span> <span class="variable">$CONF</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"$?"</span>=<span class="string">"0"</span> ]</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"redis is running..."</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        <span class="keyword">if</span> [ ! -f <span class="variable">$PIDFILE</span> ] </span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"<span class="variable">$PIDFILE</span> exists, process is not running"</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                PID = $(cat <span class="variable">$PIDFILE</span>)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"stoping.."</span></span><br><span class="line">                <span class="variable">$REDIS_CLI</span> -p <span class="variable">$REDISPORT</span> SHUTDOWN</span><br><span class="line">                <span class="keyword">while</span> [ -x <span class="variable">$PIDFILE</span> ]</span><br><span class="line">                <span class="keyword">do</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">"waiting for redis to shutdown.."</span></span><br><span class="line">                        sleep 1</span><br><span class="line">                <span class="keyword">done</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"redis stopped"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ;;</span><br><span class="line">    restart|force-reload)</span><br><span class="line">        <span class="variable">$&#123;0&#125;</span> stop</span><br><span class="line">        <span class="variable">$&#123;0&#125;</span> start</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage: /etc/init.d/redis &#123;start|stop|restart|force-reload&#125;"</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>赋予文件权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> chmod 755 redis</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置开机自启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> chkconfig redis on</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="允许远程访问Redis"><a href="#允许远程访问Redis" class="headerlink" title="允许远程访问Redis"></a>允许远程访问Redis</h1><ol>
<li><p>修改redis.conf配置文件，将</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">bind</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span></span><br></pre></td></tr></table></figure>
<p> 注释或改为</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">bind</span> 0<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.0</span></span><br></pre></td></tr></table></figure>
<p> 修改Redis认证密码，将</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> requirepass foobared</span></span><br></pre></td></tr></table></figure>
<p> 取消注释，并修改foobared为你的认证密码</p>
</li>
<li><p>设置服务器端口允许被远程访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/iptables</span></span><br></pre></td></tr></table></figure>
<p> 增加</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dprot <span class="number">6379</span> -j ACCEPT</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接并测试</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis-cli -h ip -p port -a password</span></span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/14/CentOS7 部署MySQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/14/CentOS7 部署MySQL/" itemprop="url">
                  Centos7 部署MySQL
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-14T18:02:55+08:00">
                2018-02-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h1><ul>
<li>CentOS Linux release 7.4.1708 (Core)</li>
</ul>
<h1 id="下载并安装MySQL"><a href="#下载并安装MySQL" class="headerlink" title="下载并安装MySQL"></a>下载并安装MySQL</h1><ul>
<li><a href="https://dev.mysql.com/downloads/repo/yum/" target="_blank" rel="noopener">MySQL RPM 包下载地址</a></li>
</ul>
<ol>
<li><p>从官网下载MySQL RPM包</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget http<span class="variable">s:</span>//dev.mysql.<span class="keyword">com</span>/<span class="built_in">get</span>/mysql57-community-release-el7-<span class="number">11</span>.noarch.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>校验PRM是否正确</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">md5sum</span> <span class="selector-tag">mysql57-community-release-el7-11</span><span class="selector-class">.noarch</span><span class="selector-class">.rpm</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装RPM</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">rpm</span> <span class="selector-tag">-ivh</span> <span class="selector-tag">mysql57-community-release-el7-11</span><span class="selector-class">.noarch</span><span class="selector-class">.rpm</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装MySQL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum install mysql-server</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="配置MySQL"><a href="#配置MySQL" class="headerlink" title="配置MySQL"></a>配置MySQL</h1><ol>
<li><p>将MySQL加入守护进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl start mysqld</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>检测MySQL服务是否启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> netstat -tuln | grep 3306</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取root的默认密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> grep <span class="string">'temporary password'</span> /var/<span class="built_in">log</span>/mysqld.log</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置MySQL服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mysql_secure_installation</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>进入交互式界面进行MySQL配置</p>
<ul>
<li>是否重置root密码</li>
<li>规则：输入一个包含至少一个大写字母，一个小写字母，一个数字和一个特殊字符的新的8个字符的密码。</li>
<li><p><img src="/images/Centos7 部署MySQL-1.png" alt=""></p>
</li>
<li><p>是否删除匿名用户</p>
</li>
<li><p><img src="/images/Centos7 部署MySQL-2.png" alt=""></p>
</li>
<li><p>是否删除test服务器</p>
</li>
<li><p><img src="/images/Centos7 部署MySQL-3.png" alt=""></p>
</li>
<li><p>是否重设对表的权限</p>
</li>
<li><img src="/images/Centos7 部署MySQL-4.png" alt=""></li>
</ul>
</li>
<li><p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mysqladmin -u root -p version</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置开机自启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">enable</span> mysqld.service</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="建立用户"><a href="#建立用户" class="headerlink" title="建立用户"></a>建立用户</h1><ol>
<li><p>登录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mysql -uroot -p</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>建立用户</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">CREATE</span> USER <span class="string">'username'</span>@<span class="string">'localhost'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'password'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>授权</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT <span class="literal">ALL</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'username'</span>@<span class="string">'localhost'</span> ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>刷新缓存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="允许远程登录"><a href="#允许远程登录" class="headerlink" title="允许远程登录"></a>允许远程登录</h1><ol>
<li><p>授权</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT <span class="literal">ALL</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'username'</span>@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'password'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看用户信息</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">user</span>,host,authentication_string <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置iptables</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/iptables</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>加入<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-A INPUT -p tcp -m <span class="keyword">state</span> --state NEW -m tcp --dport <span class="number">3306</span> -j ACCEPT</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li>测试<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mysql -u username -p password -h ip -P port</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-mysql-on-centos-7" target="_blank" rel="noopener">How To Install MySQL on CentOS 7</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/14/分布式部署Pyspider/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/14/分布式部署Pyspider/" itemprop="url">
                  分布式部署PySpider
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-14T16:24:30+08:00">
                2018-02-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pyspider/" itemprop="url" rel="index">
                    <span itemprop="name">pyspider</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>CentOS Linux release 7.4.1708 (Core) * 2</li>
<li>Python 2.7.5</li>
<li>pip 9.0.1</li>
</ul>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><ul>
<li>在2台服务器上分布式部署PySpider爬虫框架，各服务器中PySpider组件如下：</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">主机</th>
<th style="text-align:center">scheduler</th>
<th style="text-align:center">fetcher</th>
<th style="text-align:center">processor</th>
<th style="text-align:center">webui</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Master</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
</tr>
<tr>
<td style="text-align:center">Slave</td>
<td style="text-align:center"></td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
</tr>
</tbody>
</table>
<h1 id="安装并配置Redis"><a href="#安装并配置Redis" class="headerlink" title="安装并配置Redis"></a>安装并配置Redis</h1><ul>
<li>配置Master，上一篇文章 →_→ <a href="https://zjhdota.github.io/2018/02/14/CentOS7%20%E9%83%A8%E7%BD%B2Redis/" target="_blank" rel="noopener">传送门</a></li>
</ul>
<h1 id="安装并配置MySQL"><a href="#安装并配置MySQL" class="headerlink" title="安装并配置MySQL"></a>安装并配置MySQL</h1><ul>
<li>配置Master，上一篇文章 →_→ <a href="https://zjhdota.github.io/2018/02/14/CentOS7%20%E9%83%A8%E7%BD%B2MySQL/" target="_blank" rel="noopener">传送门</a></li>
</ul>
<h1 id="安装并配置PhantomJS"><a href="#安装并配置PhantomJS" class="headerlink" title="安装并配置PhantomJS"></a>安装并配置PhantomJS</h1><ul>
<li><p><a href="http://phantomjs.org/download.html" target="_blank" rel="noopener">PhantomJS官网</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tar -jxvf phantomjs-2.1.1-linux-x86_64.tar.bz2</span></span><br></pre></td></tr></table></figure>
<p>创建软连接，根据实际情况(绝对路径)</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ln -s <span class="regexp">/home/gu</span>est<span class="regexp">/phantomjs-2.1.1-linux-x86_64/</span>bin<span class="regexp">/phantomjs /u</span>sr<span class="regexp">/bin/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> phantomjs -v</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="安装并配置PySpider"><a href="#安装并配置PySpider" class="headerlink" title="安装并配置PySpider"></a>安装并配置PySpider</h1><ul>
<li>配置Master、Slave</li>
</ul>
<ol>
<li><p>安装Pyspider </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> pip install pyspider</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<a href="https://pypi.python.org/pypi/redis" target="_blank" rel="noopener">redis-py</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> pip install redis</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<a href="https://pypi.python.org/pypi/mysql-connector/" target="_blank" rel="noopener">mysql-connector</a></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># pip install mysql-connector==<span class="number">2.1</span><span class="number">.6</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写conf.json(PySpsider的启动配置文件)</p>
<ul>
<li>主要参数说明：<br>user 为用户名，password为密码，ip为地址，port为端口号，<br>requirepass为Redis认证密码。</li>
<li>Master和Slave<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"taskdb"</span>: <span class="string">"mysql+taskdb://user:password@ip:port/taskdb"</span>,</span><br><span class="line">  <span class="attr">"projectdb"</span>: <span class="string">"mysql+projectdb://user:password@ip:port/projectdb"</span>,</span><br><span class="line">  <span class="attr">"resultdb"</span>: <span class="string">"mysql+resultdb://user:password@ip:port/resultdb"</span>,</span><br><span class="line">  <span class="attr">"message_queue"</span>: <span class="string">"redis://:requirepass@ip/15"</span>,</span><br><span class="line">  <span class="attr">"phantomjs-proxy"</span>: <span class="string">"127.0.0.1:25555"</span>,</span><br><span class="line">  <span class="attr">"webui"</span>: &#123;</span><br><span class="line">  <span class="attr">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="attr">"password"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="attr">"need-auth"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>编写启动脚本文件run.py</p>
<ul>
<li><p>Master</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#schedular</span></span><br><span class="line">nohup pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span><span class="keyword">scheduler </span> &gt;&gt; <span class="keyword">scheduler.log </span><span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#phantomjs</span></span><br><span class="line">nohup pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span>phantomjs  &gt;&gt; phantomjs.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#fetcher ( 这里可以限定组件的数量 )</span></span><br><span class="line">for ((i=<span class="number">1</span><span class="comment">; i&lt;=1; i++)); do</span></span><br><span class="line"></span><br><span class="line">nohup pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span>--phantomjs-proxy=<span class="string">"127.0.0.1:25555"</span> fetcher &gt;&gt; fetcher.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line">pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span>processor &gt;&gt; processor.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line">pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span>result_worker &gt;&gt; result_worker.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment">#webui</span></span><br><span class="line">pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span>webui &gt;&gt; webui.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>授予脚本权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> chmod 755 run.sh</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Slave</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#phantomjs</span></span><br><span class="line">nohup pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span>phantomjs  &gt;&gt; phantomjs.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#fetcher ( 这里可以限定组件的数量 )</span></span><br><span class="line">for ((i=<span class="number">1</span><span class="comment">; i&lt;=1; i++)); do</span></span><br><span class="line"></span><br><span class="line">nohup pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span>--phantomjs-proxy=<span class="string">"127.0.0.1:25555"</span> fetcher &gt;&gt; fetcher.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line">pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span>processor &gt;&gt; processor.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line">pyspider -c <span class="built_in">config</span>.<span class="keyword">json </span>result_worker &gt;&gt; result_worker.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</li>
<li><p>授予脚本权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> chmod 755 run.sh</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>编写停止脚本文件kill.py</p>
<ul>
<li><p>Master和Slave</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sudo <span class="keyword">ps</span> -ef|<span class="keyword">grep</span> pyspider|<span class="keyword">grep</span> -v <span class="keyword">grep</span> | awk &#123;<span class="string">'print $2'</span>&#125;| xargs kill</span><br></pre></td></tr></table></figure>
</li>
<li><p>授予脚本权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> chmod 755 kill.sh</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>开启并测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ./run.py</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.pyspider.cn/book/pyspider/Deployment-6.html" target="_blank" rel="noopener">PySpider中文网</a></li>
<li><a href="http://docs.pyspider.org/en/latest/Deployment/" target="_blank" rel="noopener">PySpider官方文档</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/11/scrapy-爬取链家网租房信息/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/11/scrapy-爬取链家网租房信息/" itemprop="url">
                  scrapy 爬取链家网租房信息
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-11T08:43:08+08:00">
                2017-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python-爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">Python 爬虫</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要记录学习使用scrapy来获取链家网中北京地区的租房信息，并将获取到的信息存储到MySQL数据库的过程。</p>
<h1 id="本机主要运行环境"><a href="#本机主要运行环境" class="headerlink" title="本机主要运行环境"></a>本机主要运行环境</h1><ul>
<li>Arch Linux</li>
<li>scrapy</li>
<li>MySQL</li>
<li>Python3.6</li>
</ul>
<h1 id="安装scrapy"><a href="#安装scrapy" class="headerlink" title="安装scrapy"></a>安装scrapy</h1><p>为了方便安装,以及解决依赖问题,我们选择用pip安装scrapy.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> pip install Scrapy</span></span><br></pre></td></tr></table></figure></p>
<p>装好后输入<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> scrapy</span></span><br></pre></td></tr></table></figure></p>
<p>出现如下图结果：<br><img src="/images/scrapy.png" alt=""><br>附上<a href="http://scrapy-chs.readthedocs.io/zh_CN/0.24/intro/tutorial.html" target="_blank" rel="noopener">scrapy 中文使用手册</a>便于使用</p>
<h1 id="初步了解scrapy"><a href="#初步了解scrapy" class="headerlink" title="初步了解scrapy"></a>初步了解scrapy</h1><p>scrapy 目录结构:<br><img src="/images/scrapy2.png" alt=""></p>
<p>文件简要说明:</p>
<ul>
<li>scrapy.cfg: 项目的配置文件,用于配置项目名称、URL等属性</li>
<li>LianjiaSpider/: 该项目的python模块。</li>
<li>LianjiaSpider/items.py: 项目中的item文件.保存爬取到的数据</li>
<li>LianjiaSpider/pipelines.py: 项目中的pipelines文件，将item保存的数据进行处理</li>
<li>LianjiaSpider/settings.py: 项目的设置文件.用于配置爬虫的属性</li>
<li>LianjiaSpider/middlewares.py 项目中间件的配置。例，配置ip池或者UA池</li>
<li>LianjiaSpider/spiders/: 放置爬虫代码的目录.</li>
</ul>
<h1 id="编写爬虫"><a href="#编写爬虫" class="headerlink" title="编写爬虫"></a>编写爬虫</h1><p>先创建个scrapy工程,命令行输入<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> scrapy startproject LianjiaSpider</span></span><br></pre></td></tr></table></figure></p>
<p>我们在spiders目录下,新建个爬虫文件叫LianjiaSpider.py<br>在这个爬虫文件中，爬虫必须继承scrapy.Spider这个爬虫类<br>此外还必须定义如下三个属性</p>
<ol>
<li>name:定义爬虫名字</li>
<li>star_urls:用于存储待爬取的URL列表</li>
<li>parse():用于解析URL完成下载后Respoense对象,以及生成下一个待处理的URL的Request对象</li>
</ol>
<p>废话不多说，直接上代码<br>LianjiaSpider.py<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line">import scrapy</span><br><span class="line"><span class="built_in">from</span> ..<span class="keyword">items</span> import LianjiaspiderItem</span><br><span class="line"></span><br><span class="line">class LianjiaSpider(scrapy.spiders.Spider):</span><br><span class="line">    name = <span class="string">'LianjiaSpider'</span> <span class="comment"># 爬虫名称</span></span><br><span class="line">    start_urls = [] <span class="comment"># 存储爬虫URL</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">101</span>):</span><br><span class="line">        start_urls.append(<span class="string">'https://bj.lianjia.com/zufang/pg'</span>+str(i)) <span class="comment"># 存储链家网北京租房信息前100页的URL</span></span><br><span class="line">    allowed_domains = [<span class="string">"linajia.com"</span>]</span><br><span class="line"></span><br><span class="line">    def parse(self, response):</span><br><span class="line">        <span class="keyword">item</span> = LianjiaspiderItem() <span class="comment"># 定义item类的对象用于储存数据</span></span><br><span class="line">        title_list = response.xpath(<span class="string">"//li[@data-el='zufang']/div[2]/h2/a/text()"</span>).extract() <span class="comment"># 获取所有获取租房标题</span></span><br><span class="line">        location_list = response.xpath(<span class="string">"//li[@data-el='zufang']/div[2]/div[1]/div[1]/a/span/text()"</span>).extract() <span class="comment"># 获取所有房子地理位置</span></span><br><span class="line">        zone_list = response.xpath(<span class="string">"//li[@data-el='zufang']/div[2]/div[1]/div[1]/span[1]/span/text()"</span>).extract() <span class="comment"># 获取所有房子厅室信息</span></span><br><span class="line">        meters_list = response.xpath(<span class="string">"//li[@data-el='zufang']/div[2]/div[1]/div[1]/span[2]/text()"</span>).extract() <span class="comment"># 获取所有房子的平米</span></span><br><span class="line">        direction_list = response.xpath(<span class="string">"//li[@data-el='zufang']/div[2]/div[1]/div[1]/span[3]/text()"</span>).extract() <span class="comment"># 获取所有房子朝向</span></span><br><span class="line">        money_list = response.xpath(<span class="string">"//li[@data-el='zufang']/div[2]/div[2]/div[1]/span/text()"</span>).extract() <span class="comment"># 获取所有房子的月租</span></span><br><span class="line">        <span class="keyword">for</span> i, j, k, l, m, n <span class="keyword">in</span> zip(title_list, location_list, zone_list, meters_list, direction_list, money_list): <span class="comment"># 将每种信息组合在一起,并传给一个item</span></span><br><span class="line">            <span class="keyword">item</span>[<span class="string">'title'</span>] = i</span><br><span class="line">            <span class="keyword">item</span>[<span class="string">'location'</span>] = j</span><br><span class="line">            <span class="keyword">item</span>[<span class="string">'zone'</span>] = k</span><br><span class="line">            <span class="keyword">item</span>[<span class="string">'meters'</span>] = l</span><br><span class="line">            <span class="keyword">item</span>[<span class="string">'direction'</span>] = m</span><br><span class="line">            <span class="keyword">item</span>[<span class="string">'money'</span>] = n</span><br><span class="line">            yield <span class="keyword">item</span></span><br></pre></td></tr></table></figure></p>
<p>item.py<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># http://doc.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line">import <span class="keyword">scrapy</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">class </span>LianjiaspiderItem(<span class="keyword">scrapy.Item):</span></span><br><span class="line"><span class="keyword"> </span>   <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    <span class="comment"># name = scrapy.Field()</span></span><br><span class="line">    title = <span class="keyword">scrapy.Field() </span><span class="comment"># 用于存储房子标题</span></span><br><span class="line">    location = <span class="keyword">scrapy.Field() </span><span class="comment"># 用于存储地理位置信息</span></span><br><span class="line">    zone = <span class="keyword">scrapy.Field() </span><span class="comment"># 用户存储房子的厅室信息</span></span><br><span class="line">    meters = <span class="keyword">scrapy.Field() </span><span class="comment"># 用于存储房子的平米信息</span></span><br><span class="line">    <span class="keyword">direction </span>= <span class="keyword">scrapy.Field() </span><span class="comment"># 用于存储房子的朝向信息</span></span><br><span class="line">    money = <span class="keyword">scrapy.Field() </span><span class="comment"># 用于存储房子的月租信息</span></span><br></pre></td></tr></table></figure></p>
<p>pipelines.py<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define your item pipelines here</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Don't forget to add your pipeline to the ITEM_PIPELINES setting</span></span><br><span class="line"><span class="comment"># See: http://doc.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line">import MySQLdb</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LianjiaspiderPipeline</span>(<span class="title">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span><span class="params">(<span class="keyword">self</span>, spider)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.con = MySQLdb.connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'密码'</span>, <span class="string">'数据库名字'</span>)</span><br><span class="line">        <span class="keyword">self</span>.cursor = <span class="keyword">self</span>.con.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(<span class="keyword">self</span>, item, spider)</span></span><span class="symbol">:</span></span><br><span class="line">        insert_sql = <span class="string">"INSERT INTO lianjia(TITLE, LOCATION, ZONE, METERS, DIRECTION, MONEY) VALUES ('&#123;&#125;', '&#123;&#125;', '&#123;&#125;', '&#123;&#125;', '&#123;&#125;', '&#123;&#125;')"</span>.format(item[<span class="string">'title'</span>], item[<span class="string">'location'</span>], item[<span class="string">'zone'</span>], item[<span class="string">'meters'</span>], item[<span class="string">'direction'</span>], item[<span class="string">'money'</span>])</span><br><span class="line">        <span class="keyword">self</span>.cursor.execute(insert_sql) <span class="comment"># 执行sql语句</span></span><br><span class="line">        <span class="keyword">self</span>.con.commit() <span class="comment"># 提交到数据库，insert和updata语句必须执行这句</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spider_close</span><span class="params">(<span class="keyword">self</span>, spider)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.con.close()</span><br></pre></td></tr></table></figure></p>
<p>在项目配置文件settings.py中添加如下代码<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   'LianjiaSpider.pipelines.LianjiaspiderPipeline': 300,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：<br>因为scrapy爬虫在请求URL的时候会遵循robots.txt中的协议，恰恰链家网中robots.txt是禁止爬虫爬取根目录的，所以我们要在项目配置文件settings.py中配置<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ROBOTSTXT_OBEY</span> = <span class="literal">False</span></span><br></pre></td></tr></table></figure></p>
<h1 id="优化爬虫"><a href="#优化爬虫" class="headerlink" title="优化爬虫"></a>优化爬虫</h1><p>为了使我们的爬虫能够顺利的进行，并且尽量使目标网站不会封禁我们的IP，我们需要如下几种方法去配置爬虫</p>
<ol>
<li><p>禁用cookie,在项目配置文件settings.py中添加</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">COOKIES_ENABLED</span> = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置爬取延迟,在项目配置文件settings.py中添加</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">DOWNLOAD_DELAY</span> = <span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置user_agent池,随机分配user__agent<br> 这里我没用middlewares.py来编写中间件，而是在settings.py的同级目录中新建个中间件useragent_middleware.py，代码如下:</p>
 <figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="title">from</span> scrapy.downloadermiddlewares.useragent <span class="keyword">import</span> UserAgentMiddleware</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">RotateUserAgentMiddleware</span>(<span class="type">UserAgentMiddleware</span>):</span></span><br><span class="line"><span class="class">	def __init__(<span class="title">self</span>, <span class="title">user_agent</span>=''):</span></span><br><span class="line"><span class="class">	    self.user_agent = user_agent</span></span><br><span class="line"><span class="class">	def process_request(<span class="title">self</span>, <span class="title">request</span>, <span class="title">spider</span>):</span></span><br><span class="line"><span class="class">	    ua = random.choice(<span class="title">self</span>.<span class="title">user_agent_list</span>)</span></span><br><span class="line"><span class="class">	    if ua:</span></span><br><span class="line"><span class="class">	        request.headers.setdefault('<span class="type">User</span>-<span class="type">Agent</span>', <span class="title">ua</span>)</span></span><br><span class="line"><span class="class">	#the default user_agent_list composes chrome,<span class="type">IE</span>,firefox,<span class="type">Mozilla</span>,opera,netscape</span></span><br><span class="line"><span class="class">	#for more user agent strings,you can find it in http://www.useragentstring.com/pages/useragentstring.php</span></span><br><span class="line"><span class="class">	user_agent_list = [</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.3.6; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Nexus</span> <span class="type">S</span> <span class="type">Build</span>/<span class="type">GRK39F</span>) <span class="type">AppleWebKit</span>/533.1 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/533.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Avant</span> <span class="type">Browser</span>/1.2.789rel1 (<span class="title">http</span>://<span class="title">www</span>.<span class="title">avantbrowser</span>.<span class="title">com</span>)",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="title">en</span>-<span class="type">US</span>) <span class="type">AppleWebKit</span>/532.5 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/4.0.249.0 <span class="type">Safari</span>/532.5",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 5.2; <span class="title">en</span>-<span class="type">US</span>) <span class="type">AppleWebKit</span>/532.9 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/5.0.310.0 <span class="type">Safari</span>/532.9",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 5.1; <span class="title">en</span>-<span class="type">US</span>) <span class="type">AppleWebKit</span>/534.7 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/7.0.514.0 <span class="type">Safari</span>/534.7",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 6.0; <span class="title">en</span>-<span class="type">US</span>) <span class="type">AppleWebKit</span>/534.14 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/9.0.601.0 <span class="type">Safari</span>/534.14",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="title">en</span>-<span class="type">US</span>) <span class="type">AppleWebKit</span>/534.14 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/10.0.601.0 <span class="type">Safari</span>/534.14",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="title">en</span>-<span class="type">US</span>) <span class="type">AppleWebKit</span>/534.20 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/11.0.672.2 <span class="type">Safari</span>/534.20",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="type">WOW64</span>) <span class="type">AppleWebKit</span>/534.27 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/12.0.712.0 <span class="type">Safari</span>/534.27",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="type">WOW64</span>) <span class="type">AppleWebKit</span>/535.1 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/13.0.782.24 <span class="type">Safari</span>/535.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 6.0) <span class="type">AppleWebKit</span>/535.2 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/15.0.874.120 <span class="type">Safari</span>/535.2",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="type">WOW64</span>) <span class="type">AppleWebKit</span>/535.7 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Chrome</span>/16.0.912.36 <span class="type">Safari</span>/535.7",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 6.0 <span class="title">x64</span>; <span class="title">en</span>-<span class="type">US</span>; <span class="title">rv</span>:1.9<span class="title">pre</span>) <span class="type">Gecko</span>/2008072421 <span class="type">Minefield</span>/3.0.2pre",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 5.1; <span class="title">en</span>-<span class="type">US</span>; <span class="title">rv</span>:1.9.0.10) <span class="type">Gecko</span>/2009042316 <span class="type">Firefox</span>/3.0.10",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 6.0; <span class="title">en</span>-<span class="type">GB</span>; <span class="title">rv</span>:1.9.0.11) <span class="type">Gecko</span>/2009060215 <span class="type">Firefox</span>/3.0.11 (.<span class="type">NET</span> <span class="type">CLR</span> 3.5.30729)",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 6.0; <span class="title">en</span>-<span class="type">US</span>; <span class="title">rv</span>:1.9.1.6) <span class="type">Gecko</span>/20091201 <span class="type">Firefox</span>/3.5.6 <span class="type">GTB5</span>",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">NT</span> 5.1; <span class="title">tr</span>; <span class="title">rv</span>:1.9.2.8) <span class="type">Gecko</span>/20100722 <span class="type">Firefox</span>/3.6.8 ( .<span class="type">NET</span> <span class="type">CLR</span> 3.5.30729; .<span class="type">NET4</span>.0E)",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="title">rv</span>:2.0.1) <span class="type">Gecko</span>/20100101 <span class="type">Firefox</span>/4.0.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="type">Win64</span>; <span class="title">x64</span>; <span class="title">rv</span>:2.0.1) <span class="type">Gecko</span>/20100101 <span class="type">Firefox</span>/4.0.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 5.1; <span class="title">rv</span>:5.0) <span class="type">Gecko</span>/20100101 <span class="type">Firefox</span>/5.0",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="type">WOW64</span>; <span class="title">rv</span>:6.0<span class="title">a2</span>) <span class="type">Gecko</span>/20110622 <span class="type">Firefox</span>/6.0a2",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="type">WOW64</span>; <span class="title">rv</span>:7.0.1) <span class="type">Gecko</span>/20100101 <span class="type">Firefox</span>/7.0.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span> <span class="type">NT</span> 6.1; <span class="type">WOW64</span>; <span class="title">rv</span>:2.0<span class="title">b4pre</span>) <span class="type">Gecko</span>/20100815 <span class="type">Minefield</span>/4.0b4pre",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/4.0 (<span class="title">compatible</span>; <span class="type">MSIE</span> 5.5; <span class="type">Windows</span> <span class="type">NT</span> 5.0 )",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/4.0 (<span class="title">compatible</span>; <span class="type">MSIE</span> 5.5; <span class="type">Windows</span> 98; <span class="type">Win</span> 9<span class="title">x</span> 4.90)",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Windows</span> <span class="type">XP</span>) <span class="type">Gecko</span> <span class="type">MultiZilla</span>/1.6.1.0a",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/2.02E (<span class="type">Win95</span>; <span class="type">U</span>)",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/3.01Gold (<span class="type">Win95</span>; <span class="type">I</span>)",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/4.8 [en] (<span class="type">Windows</span> <span class="type">NT</span> 5.1; <span class="type">U</span>)",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Windows</span>; <span class="type">U</span>; <span class="type">Win98</span>; <span class="title">en</span>-<span class="type">US</span>; <span class="title">rv</span>:1.4) <span class="type">Gecko</span> <span class="type">Netscape</span>/7.1 (<span class="title">ax</span>)",</span></span><br><span class="line"><span class="class">	"<span class="type">HTC_Dream</span> <span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.5; <span class="title">en</span>-<span class="title">ca</span>; <span class="type">Build</span>/<span class="type">CUPCAKE</span>) <span class="type">AppleWebKit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span>/525.20.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="title">hp</span>-<span class="title">tablet</span>; <span class="type">Linux</span>; <span class="title">hpwOS</span>/3.0.2; <span class="type">U</span>; <span class="title">de</span>-<span class="type">DE</span>) <span class="type">AppleWebKit</span>/534.6 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) wOSBrowser/234.40.1 <span class="type">Safari</span>/534.6 <span class="type">TouchPad</span>/1.0",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.5; <span class="title">en</span>-<span class="title">us</span>; <span class="title">sdk</span> <span class="type">Build</span>/<span class="type">CUPCAKE</span>) <span class="type">AppleWebkit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span>/525.20.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.1; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Nexus</span> <span class="type">One</span> <span class="type">Build</span>/<span class="type">ERD62</span>) <span class="type">AppleWebKit</span>/530.17 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/530.17",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.2; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Nexus</span> <span class="type">One</span> <span class="type">Build</span>/<span class="type">FRF91</span>) <span class="type">AppleWebKit</span>/533.1 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/533.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.5; <span class="title">en</span>-<span class="title">us</span>; <span class="title">htc_bahamas</span> <span class="type">Build</span>/<span class="type">CRB17</span>) <span class="type">AppleWebKit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span>/525.20.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.1-<span class="title">update1</span>; <span class="title">de</span>-<span class="title">de</span>; <span class="type">HTC</span> <span class="type">Desire</span> 1.19.161.5 <span class="type">Build</span>/<span class="type">ERE27</span>) <span class="type">AppleWebKit</span>/530.17 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/530.17",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.2; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Sprint</span> <span class="type">APA9292KT</span> <span class="type">Build</span>/<span class="type">FRF91</span>) <span class="type">AppleWebKit</span>/533.1 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/533.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.5; <span class="title">de</span>-<span class="title">ch</span>; <span class="type">HTC</span> <span class="type">Hero</span> <span class="type">Build</span>/<span class="type">CUPCAKE</span>) <span class="type">AppleWebKit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span>/525.20.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.2; <span class="title">en</span>-<span class="title">us</span>; <span class="type">ADR6300</span> <span class="type">Build</span>/<span class="type">FRF91</span>) <span class="type">AppleWebKit</span>/533.1 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/533.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.1; <span class="title">en</span>-<span class="title">us</span>; <span class="type">HTC</span> <span class="type">Legend</span> <span class="type">Build</span>/<span class="title">cupcake</span>) <span class="type">AppleWebKit</span>/530.17 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/530.17",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.5; <span class="title">de</span>-<span class="title">de</span>; <span class="type">HTC</span> <span class="type">Magic</span> <span class="type">Build</span>/<span class="type">PLAT</span>-<span class="type">RC33</span>) <span class="type">AppleWebKit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span>/525.20.1 <span class="type">FirePHP</span>/0.3",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.6; <span class="title">en</span>-<span class="title">us</span>; <span class="type">HTC_TATTOO_A3288</span> <span class="type">Build</span>/<span class="type">DRC79</span>) <span class="type">AppleWebKit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span>/525.20.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.0; <span class="title">en</span>-<span class="title">us</span>; <span class="title">dream</span>) <span class="type">AppleWebKit</span>/525.10  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.0.4 <span class="type">Mobile</span> <span class="type">Safari</span>/523.12.2",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.5; <span class="title">en</span>-<span class="title">us</span>; <span class="type">T</span>-<span class="type">Mobile</span> <span class="type">G1</span> <span class="type">Build</span>/<span class="type">CRB43</span>) <span class="type">AppleWebKit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span> 525.20.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.5; <span class="title">en</span>-<span class="title">gb</span>; <span class="type">T</span>-<span class="type">Mobile_G2_Touch</span> <span class="type">Build</span>/<span class="type">CUPCAKE</span>) <span class="type">AppleWebKit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span>/525.20.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.0; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Droid</span> <span class="type">Build</span>/<span class="type">ESD20</span>) <span class="type">AppleWebKit</span>/530.17 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/530.17",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.2; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Droid</span> <span class="type">Build</span>/<span class="type">FRG22D</span>) <span class="type">AppleWebKit</span>/533.1 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/533.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.0; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Milestone</span> <span class="type">Build</span>/ <span class="type">SHOLS_U2_01</span>.03.1) <span class="type">AppleWebKit</span>/530.17 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/530.17",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.0.1; <span class="title">de</span>-<span class="title">de</span>; <span class="type">Milestone</span> <span class="type">Build</span>/<span class="type">SHOLS_U2_01</span>.14.0) <span class="type">AppleWebKit</span>/530.17 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/530.17",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 3.0; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Xoom</span> <span class="type">Build</span>/<span class="type">HRI39</span>) <span class="type">AppleWebKit</span>/525.10  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.0.4 <span class="type">Mobile</span> <span class="type">Safari</span>/523.12.2",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 0.5; <span class="title">en</span>-<span class="title">us</span>) <span class="type">AppleWebKit</span>/522  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Safari</span>/419.3",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.1; <span class="title">en</span>-<span class="title">gb</span>; <span class="title">dream</span>) <span class="type">AppleWebKit</span>/525.10  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.0.4 <span class="type">Mobile</span> <span class="type">Safari</span>/523.12.2",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.0; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Droid</span> <span class="type">Build</span>/<span class="type">ESD20</span>) <span class="type">AppleWebKit</span>/530.17 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/530.17",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.1; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Nexus</span> <span class="type">One</span> <span class="type">Build</span>/<span class="type">ERD62</span>) <span class="type">AppleWebKit</span>/530.17 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/530.17",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.2; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Sprint</span> <span class="type">APA9292KT</span> <span class="type">Build</span>/<span class="type">FRF91</span>) <span class="type">AppleWebKit</span>/533.1 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/533.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.2; <span class="title">en</span>-<span class="title">us</span>; <span class="type">ADR6300</span> <span class="type">Build</span>/<span class="type">FRF91</span>) <span class="type">AppleWebKit</span>/533.1 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/533.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 2.2; <span class="title">en</span>-<span class="title">ca</span>; <span class="type">GT</span>-<span class="type">P1000M</span> <span class="type">Build</span>/<span class="type">FROYO</span>) <span class="type">AppleWebKit</span>/533.1 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Mobile</span> <span class="type">Safari</span>/533.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 3.0.1; <span class="title">fr</span>-<span class="title">fr</span>; <span class="type">A500</span> <span class="type">Build</span>/<span class="type">HRI66</span>) <span class="type">AppleWebKit</span>/534.13 (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/4.0 <span class="type">Safari</span>/534.13",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 3.0; <span class="title">en</span>-<span class="title">us</span>; <span class="type">Xoom</span> <span class="type">Build</span>/<span class="type">HRI39</span>) <span class="type">AppleWebKit</span>/525.10  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.0.4 <span class="type">Mobile</span> <span class="type">Safari</span>/523.12.2",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.6; <span class="title">es</span>-<span class="title">es</span>; <span class="type">SonyEricssonX10i</span> <span class="type">Build</span>/<span class="type">R1FA016</span>) <span class="type">AppleWebKit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span>/525.20.1",</span></span><br><span class="line"><span class="class">	"<span class="type">Mozilla</span>/5.0 (<span class="type">Linux</span>; <span class="type">U</span>; <span class="type">Android</span> 1.6; <span class="title">en</span>-<span class="title">us</span>; <span class="type">SonyEricssonX10i</span> <span class="type">Build</span>/<span class="type">R1AA056</span>) <span class="type">AppleWebKit</span>/528.5  (<span class="type">KHTML</span>, <span class="title">like</span> <span class="type">Gecko</span>) <span class="type">Version</span>/3.1.2 <span class="type">Mobile</span> <span class="type">Safari</span>/525.20.1",</span></span><br><span class="line"><span class="class">]</span></span><br></pre></td></tr></table></figure>
<p> 在settings.py添加设置</p>
 <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line">	<span class="string">'scrapy.downloadermiddlewares.useragent.UserAgentMiddleware'</span><span class="symbol">:None</span>,</span><br><span class="line">	<span class="string">'LianjiaSpider.useragent_middleware.RotateUserAgentMiddleware'</span><span class="symbol">:</span><span class="number">100</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 其中LianjiaSPider是项目名字;useragent_middleware是UA中间件的文件名字;RotateUserAgentMiddleware是文件中的类</p>
</li>
<li><p>设置proxy池，随机分配ip<br> 因为要设置代理ip，这里可以用<a href="http://www.xicidaili.com/" target="_blank" rel="noopener">西刺</a>免费的代理ip，尽量选择存活时间长的，速度快的节点。<br> 在settings.py的同级目录下建立一个新的ip池中间件，文件名为proxy_middleware.py，代码如下:</p>
 <figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line">import random</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyMiddleware</span>(<span class="title">object</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, ip=<span class="string">''</span>)</span></span><span class="symbol">:</span></span><br><span class="line">	    <span class="keyword">self</span>.ip = ip</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(<span class="keyword">self</span>, request, spider)</span></span><span class="symbol">:</span></span><br><span class="line">	    ip = random.choice(<span class="keyword">self</span>.ip_list)</span><br><span class="line">	    print(ip)</span><br><span class="line">	    request.meta[<span class="string">'proxy'</span>] = ip</span><br><span class="line"></span><br><span class="line">	ip_list =[</span><br><span class="line">           <span class="string">'https://218.29.111.106:9999'</span>,</span><br><span class="line">           <span class="string">'https://119.23.129.24:3128'</span>,]</span><br></pre></td></tr></table></figure>
<p> 在sttings.py中添加设置</p>
 <figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line">	'<span class="attribute">scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware'</span>: 110,</span><br><span class="line">	'LianjiaSpider<span class="variable">.proxy_middleware</span><span class="variable">.ProxyMiddleware</span>': 100,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 注意：<br> 如果要爬取目标的URL为http，那么代理ip选择http协议的，否则，代理ip选择https协议的。</p>
</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过本次scrapy的学习，了解到了scrapy 运行机制。简述此过程Scheduler用于存储URL，它将URL传递给Downloader，Downloader请求URL，并将响应传递给Spiders，Spiders有两个主要作用1.对信息进行采集，并传递给Item Pipelines去处理 2.将下一次要请求的URL加入到Scheduler中。附上一张图，供学习使用:<br><img src="/images/scrapy3.png" alt=""><br>有时候用scrapy爬取的数据过多，导致ip被封禁，所以我们要对爬虫的属性进行配置，也就是说编辑settings.py文件，此外还可以设置ip池，和动态分配UA来反反爬虫。<br>更多的scrapy使用技巧会在之后学以致用。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/07/获取支付宝订单，并存储的数据库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/07/获取支付宝订单，并存储的数据库/" itemprop="url">
                  Python爬虫模拟登录支付宝并获取订单信息
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-07T18:19:46+08:00">
                2017-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python-爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">Python 爬虫</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文仅学习交流使用，记录学习用webdriver模拟登录支付宝保存cookie，再用requests.session()加载cookie并用Xpath获取订单信息，将订单存储到MySQL数据库中的过程。</p>
<h1 id="本机主要运行环境及库"><a href="#本机主要运行环境及库" class="headerlink" title="本机主要运行环境及库"></a>本机主要运行环境及库</h1><ul>
<li>Arch Linux</li>
<li>webdriver(Chrome或者FireFox)</li>
<li>Python3.6</li>
<li>selenium 库</li>
<li>json 库</li>
<li>requests 库</li>
<li>lxml 库</li>
<li>MySQLdb 库</li>
</ul>
<p>确保本机具有或类似的运行条件，webdriver 安装方法在<a href="https://zjhdota.github.io/2017/06/24/selenium-%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95163/" target="_blank" rel="noopener">selenium模拟登录163邮箱</a>中已经提到。<br>selenium、json、requests、lxml库都可以通过python的包管理工具PyPI安装。<br>Python2.x 的版本通过pip安装mysql-python 来连接MySQL数据库，Python3.x则需要通过pip安装mysqlclient来实现Python和MySQL的连接。</p>
<h1 id="获取cookie"><a href="#获取cookie" class="headerlink" title="获取cookie"></a>获取cookie</h1><p>我们用webdriver登录支付宝来获取cookie，并用json使数据持久化。<br>首先获取支付宝登录页面的URL:<br><a href="https://auth.alipay.com/login/index.htm?goto=https%3A%2F%2Flab.alipay.com%2Fuser%2Fi.htm" target="_blank" rel="noopener">https://auth.alipay.com/login/index.htm?goto=https%3A%2F%2Flab.alipay.com%2Fuser%2Fi.htm</a><br>通过Chrome开发者工具获取用户名文本框的id属性、密码文本框的name属性、和登录按钮的id属性<br><img src="/images/alipay1.gif" alt=""></p>
<p>部分代码如下:<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">driver = webdriver.Firefox()</span><br><span class="line">driver.maximize_window()</span><br><span class="line">driver.<span class="built_in">get</span>(<span class="string">'https://auth.alipay.com/login/index.htm?goto=https%3A%2F%2Fmy.alipay.com%2Fportal%2Fi.htm'</span>)</span><br><span class="line"><span class="comment"># 等待2秒页面加载完毕</span></span><br><span class="line"><span class="built_in">time</span>.sleep(<span class="number">2</span>)</span><br><span class="line">driver.find_element_by_id(<span class="string">'J-input-user'</span>).send_keys(<span class="string">'你的支付宝用户名'</span>) <span class="comment"># 输入用户名</span></span><br><span class="line">driver.find_element_by_name(<span class="string">'password_rsainput'</span>).send_keys(<span class="string">'你的支付宝密码'</span>) <span class="comment"># 输入密码</span></span><br><span class="line">driver.find_element_by_id(<span class="string">'J-login-btn'</span>).click() <span class="comment"># 点击登录按钮</span></span><br><span class="line"><span class="comment"># 获取cookie，并保存到本地</span></span><br><span class="line">cookies = driver.get_cookies()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'cookies'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    json.dump(cookies, f)</span><br><span class="line">f.<span class="built_in">close</span>()</span><br><span class="line">driver.<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure></p>
<h1 id="设置cookie"><a href="#设置cookie" class="headerlink" title="设置cookie"></a>设置cookie</h1><p>要用requests.session()请求网页进行爬取，所以我们就直接加载本地的cookie来请求网页</p>
<p>部分代码如下:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">with <span class="title">open</span>(<span class="params"><span class="string">'cookies'</span>, <span class="string">'r'</span></span>) <span class="keyword">as</span> f:</span></span><br><span class="line"><span class="function">    cookies </span>= json.load(f)</span><br><span class="line">    <span class="meta"># 将json存储的cookie 转化为dict，并更新session的coookie</span></span><br><span class="line">    <span class="keyword">for</span> cookie <span class="keyword">in</span> cookies:</span><br><span class="line">        c = &#123;cookie[<span class="string">'name'</span>]: cookie[<span class="string">'value'</span>]&#125;</span><br><span class="line">        session.cookies.update(c)</span><br></pre></td></tr></table></figure></p>
<h1 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h1><p>采用lxml来解析网页，然后通过xpath来找到相应的数据，最后存储到各自list中，为的是之后存储到数据库方便</p>
<p>部分代码如下：<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取交易记录界面</span></span><br><span class="line">html = self.session.<span class="built_in">get</span>(<span class="string">'https://consumeprod.alipay.com/record/standard.htm'</span>)</span><br><span class="line"><span class="comment"># 用lxml解析html</span></span><br><span class="line">selector= etree.HTML(html.<span class="keyword">text</span>)</span><br><span class="line"><span class="comment"># 获取最近20个交易数据</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">21</span>):</span><br><span class="line">    <span class="comment"># 获取流水号</span></span><br><span class="line">    <span class="built_in">number</span> = selector.xpath(<span class="string">'//*[@id="J-tradeNo-'</span>+str(i)+<span class="string">'"]/@title'</span>)</span><br><span class="line">    number_list.append(<span class="built_in">number</span>[<span class="number">0</span>].strip())</span><br><span class="line">    <span class="comment"># 获取交易时间</span></span><br><span class="line">    <span class="built_in">time</span> = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[2]/p[1]/text()'</span>)</span><br><span class="line">    time_list.append(<span class="built_in">time</span>[<span class="number">0</span>].strip())</span><br><span class="line">    <span class="comment"># 获取具体内容</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 交易成功的内容</span></span><br><span class="line">        content = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[3]/p[1]/a/text()'</span>)</span><br><span class="line">        content_list.append(content[<span class="number">0</span>].strip())</span><br><span class="line">    except:</span><br><span class="line">         <span class="comment"># 交易失败的内容</span></span><br><span class="line">        content = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[3]/p[1]/text()'</span>)</span><br><span class="line">        content_list.append(content[<span class="number">0</span>].strip())</span><br><span class="line">    <span class="comment"># 获取金额变动</span></span><br><span class="line">    money = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[4]/span/text()'</span>)</span><br><span class="line">    money_list.append(money[<span class="number">0</span>].strip())</span><br><span class="line">    <span class="comment"># 获取交易状态</span></span><br><span class="line">    state = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[6]/p[1]/text()'</span>)</span><br><span class="line">    state_list.append(state[<span class="number">0</span>].strip())</span><br></pre></td></tr></table></figure></p>
<h1 id="存储数据"><a href="#存储数据" class="headerlink" title="存储数据"></a>存储数据</h1><p>将存储到list中的数据，存储到mysql中</p>
<p>部分代码如下:<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接数据库</span></span><br><span class="line">db = MySQLdb.connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'数据库密码'</span>, <span class="string">'数据库'</span>)</span><br><span class="line"><span class="comment"># 获取游标</span></span><br><span class="line">cursor = db.cursor()</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">20</span>):</span><br><span class="line">    <span class="comment"># sql 插入语句，插入到alipay表中</span></span><br><span class="line">    sql = <span class="string">"INSERT IGNORE INTO alipay(NUMBER,DATE,CONTENT,MONEY,STATE) VALUES ('%s','%s','%s','%s','%s')"</span> % (number_list[i],time_list[i],content_list[i],money_list[i],state_list[i])</span><br><span class="line">    try:</span><br><span class="line">        <span class="comment"># 执行sql语句</span></span><br><span class="line">        cursor.execute(sql)</span><br><span class="line">        <span class="comment"># 提交到数据库</span></span><br><span class="line">        db.commit()</span><br><span class="line">    except:</span><br><span class="line">        <span class="comment"># 失败回滚</span></span><br><span class="line">        db.rollback()</span><br><span class="line"><span class="comment"># 关闭数据库连接</span></span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure></p>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p>将代码进行了封装，增加了对加载cookie后登录状态的确认</p>
<p>完整代码如下:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line">from selenium import webdriver</span><br><span class="line">import time</span><br><span class="line">import json</span><br><span class="line">import requests</span><br><span class="line">from lxml import etree</span><br><span class="line">import MySQLdb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlipaySpider</span>(<span class="title">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.headers = &#123;<span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.96 Safari/537.36'</span>&#125;</span><br><span class="line">        <span class="keyword">self</span>.session = requests.Session()</span><br><span class="line">        <span class="keyword">self</span>.session.headers = <span class="keyword">self</span>.headers</span><br><span class="line">        <span class="keyword">self</span>.number_list = []</span><br><span class="line">        <span class="keyword">self</span>.time_list = []</span><br><span class="line">        <span class="keyword">self</span>.content_list = []</span><br><span class="line">        <span class="keyword">self</span>.money_list = []</span><br><span class="line">        <span class="keyword">self</span>.state_list = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用webdriver 获取cookie</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_cookies</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        driver = webdriver.Firefox()</span><br><span class="line">        driver.maximize_window()</span><br><span class="line">        driver.get(<span class="string">'https://auth.alipay.com/login/index.htm?goto=https%3A%2F%2Fmy.alipay.com%2Fportal%2Fi.htm'</span>)</span><br><span class="line">        <span class="comment"># 等待2秒</span></span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        driver.find_element_by_id(<span class="string">'J-input-user'</span>).send_keys(<span class="string">'你的支付宝用户名'</span>)</span><br><span class="line">        driver.find_element_by_name(<span class="string">'password_rsainput'</span>).send_keys(<span class="string">'你的支付宝密码'</span>)</span><br><span class="line">        driver.find_element_by_id(<span class="string">'J-login-btn'</span>).click()</span><br><span class="line">        <span class="comment"># 获取cookie，并保存到本地</span></span><br><span class="line">        cookies = driver.get_cookies()</span><br><span class="line">        with open(<span class="string">'cookies'</span>,<span class="string">'w'</span>) as <span class="symbol">f:</span></span><br><span class="line">            json.dump(cookies, f)</span><br><span class="line">        f.close()</span><br><span class="line">        driver.close()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置cookie</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_cookies</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="comment"># 从文件中获取cookie</span></span><br><span class="line">        with open(<span class="string">'cookies'</span>, <span class="string">'r'</span>) as <span class="symbol">f:</span></span><br><span class="line">            cookies = json.load(f)</span><br><span class="line">        <span class="comment"># 将json存储的cookie 转化为dict，并更新session的coookie</span></span><br><span class="line">        <span class="keyword">for</span> cookie <span class="keyword">in</span> <span class="symbol">cookies:</span></span><br><span class="line">            c = &#123;cookie[<span class="string">'name'</span>]: cookie[<span class="string">'value'</span>]&#125;</span><br><span class="line">            <span class="keyword">self</span>.session.cookies.update(c)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断是否已经登录</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aready_login</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.set_cookies()</span><br><span class="line">        html_code = <span class="keyword">self</span>.session.get(<span class="string">'https://custweb.alipay.com/account/index.htm'</span>,allow_redirects=False).status_code</span><br><span class="line">        <span class="keyword">if</span> html_code == <span class="number">200</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> True</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取数据</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="comment"># 获取交易记录界面</span></span><br><span class="line">        html = <span class="keyword">self</span>.session.get(<span class="string">'https://consumeprod.alipay.com/record/standard.htm'</span>)</span><br><span class="line">        <span class="comment"># 用lxml解析html</span></span><br><span class="line">        selector= etree.HTML(html.text)</span><br><span class="line">        <span class="comment"># 获取最近20个交易数据</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">21</span>)<span class="symbol">:</span></span><br><span class="line">            <span class="comment"># 获取流水号</span></span><br><span class="line">            number = selector.xpath(<span class="string">'//*[@id="J-tradeNo-'</span>+str(i)+<span class="string">'"]/@title'</span>)</span><br><span class="line">            <span class="keyword">self</span>.number_list.append(number[<span class="number">0</span>].strip())</span><br><span class="line">            <span class="comment"># 获取交易时间</span></span><br><span class="line">            time = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[2]/p[1]/text()'</span>)</span><br><span class="line">            <span class="keyword">self</span>.time_list.append(time[<span class="number">0</span>].strip())</span><br><span class="line">            <span class="comment"># 获取具体内容</span></span><br><span class="line">            <span class="symbol">try:</span></span><br><span class="line">                <span class="comment"># 交易成功的内容</span></span><br><span class="line">                content = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[3]/p[1]/a/text()'</span>)</span><br><span class="line">                <span class="keyword">self</span>.content_list.append(content[<span class="number">0</span>].strip())</span><br><span class="line">            <span class="symbol">except:</span></span><br><span class="line">                <span class="comment"># 交易失败的内容</span></span><br><span class="line">                content = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[3]/p[1]/text()'</span>)</span><br><span class="line">                <span class="keyword">self</span>.content_list.append(content[<span class="number">0</span>].strip())</span><br><span class="line">            <span class="comment"># 获取金额变动</span></span><br><span class="line">            money = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[4]/span/text()'</span>)</span><br><span class="line">            <span class="keyword">self</span>.money_list.append(money[<span class="number">0</span>].strip())</span><br><span class="line">            <span class="comment"># 获取交易状态</span></span><br><span class="line">            state = selector.xpath(<span class="string">'//*[@id="J-item-'</span>+str(i)+<span class="string">'"]/td[6]/p[1]/text()'</span>)</span><br><span class="line">            <span class="keyword">self</span>.state_list.append(state[<span class="number">0</span>].strip())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 存储数据</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_data</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="comment"># 连接数据库</span></span><br><span class="line">        db = MySQLdb.connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'密码'</span>, <span class="string">'数据库'</span>)</span><br><span class="line">        <span class="comment"># 获取游标</span></span><br><span class="line">        cursor = db.cursor()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>)<span class="symbol">:</span></span><br><span class="line">            <span class="comment"># sql 插入语句，插入到alipay表中</span></span><br><span class="line">            sql = <span class="string">"INSERT IGNORE INTO alipay(NUMBER,DATE,CONTENT,MONEY,STATE) VALUES ('%s','%s','%s','%s','%s')"</span> % (<span class="keyword">self</span>.number_list[i],<span class="keyword">self</span>.time_list[i],<span class="keyword">self</span>.content_list[i],<span class="keyword">self</span>.money_list[i],<span class="keyword">self</span>.state_list[i])</span><br><span class="line">            <span class="symbol">try:</span></span><br><span class="line">                <span class="comment"># 执行sql语句</span></span><br><span class="line">                cursor.execute(sql)</span><br><span class="line">                <span class="comment"># 提交到数据库</span></span><br><span class="line">                db.commit()</span><br><span class="line">            <span class="symbol">except:</span></span><br><span class="line">                <span class="comment"># 失败回滚</span></span><br><span class="line">                db.rollback()</span><br><span class="line">        <span class="comment"># 关闭数据库连接</span></span><br><span class="line">        db.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total_crawl</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.save_cookies() <span class="comment"># 保存cookie</span></span><br><span class="line">        <span class="keyword">self</span>.set_cookies() <span class="comment"># 设置cookie</span></span><br><span class="line">        <span class="keyword">self</span>.get_data() <span class="comment"># 爬取数据</span></span><br><span class="line">        <span class="keyword">self</span>.save_data() <span class="comment"># 保存数据</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawl</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.get_data() <span class="comment"># 爬取数据</span></span><br><span class="line">        <span class="keyword">self</span>.save_data() <span class="comment"># 保存数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">"__main__"</span><span class="symbol">:</span></span><br><span class="line">    spider = AlipaySpider()</span><br><span class="line">    <span class="keyword">if</span> spider.aready_login() == <span class="symbol">True:</span></span><br><span class="line">        spider.crawl()</span><br><span class="line">    <span class="symbol">else:</span></span><br><span class="line">        spider.total_crawl()</span><br></pre></td></tr></table></figure></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过本次的学习，有2点不足之处。</p>
<ol>
<li>有时由于多次访问支付宝页面，导致登录页面有验证码，这样获取到的cookie就不成功了，需要再次请求，直到没有验证码，才能获取到cookie</li>
<li>数据爬取时，只能爬取到最近的20笔交易记录</li>
</ol>
<p>遗留问题会在学习更多之后解决</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/24/selenium-模拟登录163/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/24/selenium-模拟登录163/" itemprop="url">
                  selenium 模拟登录163邮箱
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-24T16:42:17+08:00">
                2017-06-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python-爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">Python 爬虫</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>记录下简单使用selenium的过程</p>
<h1 id="主要运行环境及库"><a href="#主要运行环境及库" class="headerlink" title="主要运行环境及库"></a>主要运行环境及库</h1><ul>
<li>selenium 库</li>
<li>webdriver (Chrome、Firefox等)</li>
</ul>
<h1 id="下载-webdriver并配置"><a href="#下载-webdriver并配置" class="headerlink" title="下载 webdriver并配置"></a>下载 webdriver并配置</h1><p>webdriver 下载连接如下</p>
<ul>
<li><a href="https://sites.google.com/a/chromium.org/chromedriver/downloads" target="_blank" rel="noopener">Chrome</a></li>
<li><a href="https://github.com/mozilla/geckodriver/release" target="_blank" rel="noopener">Firefox</a></li>
</ul>
<p>将下载好的webdriver 放入到/usr/bin/目录下，这样做的目的是调用时可以不指明路径</p>
<h1 id="模拟登录163邮箱"><a href="#模拟登录163邮箱" class="headerlink" title="模拟登录163邮箱"></a>模拟登录163邮箱</h1><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Chrome()</span><br><span class="line"><span class="meta"># 最大化窗口</span></span><br><span class="line">browser.maximize_window()</span><br><span class="line">browser.<span class="keyword">get</span>(<span class="string">'http://mail.163.com/'</span>)</span><br><span class="line"><span class="meta"># 停2秒，等待页面加载完毕</span></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>因为表单在iframe标签中，要想获取iframe中的内容需要从Frame跳转到iframe中<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 切换到登录表单</span></span><br><span class="line">browser.switch_to.frame(<span class="string">"x-URS-iframe"</span>)</span><br><span class="line"><span class="meta"># 填写用户名</span></span><br><span class="line">browser.find_element_by_name(<span class="string">"email"</span>).send_keys(username)</span><br><span class="line"><span class="meta"># 填写密码</span></span><br><span class="line">browser.find_element_by_name(<span class="string">"password"</span>).send_keys(password)</span><br><span class="line"><span class="meta"># 登录</span></span><br><span class="line">browser.find_element_by_id(<span class="string">"dologin"</span>).click()</span><br></pre></td></tr></table></figure></p>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户名</span></span><br><span class="line">username = input(<span class="string">'请输入用户名\n &gt; '</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    re.match(<span class="string">r'^((?!@163).)*$'</span>, username).group()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    username = re.sub(<span class="string">'@163.com$'</span>,<span class="string">''</span>,username)</span><br><span class="line"><span class="comment"># 密码</span></span><br><span class="line">password = input(<span class="string">'请输入密码\n &gt; '</span>)</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line"><span class="comment"># 最大化窗口</span></span><br><span class="line">browser.maximize_window()</span><br><span class="line">browser.get(<span class="string">'http://mail.163.com/'</span>)</span><br><span class="line"><span class="comment"># 等待2秒，等待页面加载完毕</span></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到登录表单</span></span><br><span class="line">browser.switch_to.frame(<span class="string">"x-URS-iframe"</span>)</span><br><span class="line"><span class="comment"># 填写用户名</span></span><br><span class="line">browser.find_element_by_name(<span class="string">"email"</span>).send_keys(username)</span><br><span class="line"><span class="comment"># 填写密码</span></span><br><span class="line">browser.find_element_by_name(<span class="string">"password"</span>).send_keys(password)</span><br><span class="line"><span class="comment"># 登录</span></span><br><span class="line">browser.find_element_by_id(<span class="string">"dologin"</span>).click()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/11/知乎模拟登录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/11/知乎模拟登录/" itemprop="url">
                  Python 模拟登录知乎
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-11T14:47:45+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python-爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">Python 爬虫</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前模拟登录pixiv时不需要验证码，知乎需要验证码，于是写这篇文章记录我学习模拟登录知乎的过程</p>
<hr>
<h1 id="需要的工具及环境"><a href="#需要的工具及环境" class="headerlink" title="需要的工具及环境"></a>需要的工具及环境</h1><ul>
<li>Python 3.6</li>
<li>requests 库</li>
<li>pillow 库</li>
<li>re 库</li>
<li>Chrome 浏览器</li>
</ul>
<h1 id="尝试登录"><a href="#尝试登录" class="headerlink" title="尝试登录"></a>尝试登录</h1><p>打开知乎<a href="https://www.zhihu.com" target="_blank" rel="noopener">登录页面</a>,按F12-&gt;选中‘preserve log’,登录界面如图，点击提交，获得post数据和网址<br><img src="/images/python模拟登录知乎1.png" alt=""></p>
<p>我们可以获得获得post URL 地址<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">post_url</span> = <span class="string">'https://www.zhihu.com/login/phone_num'</span> # post请求提交的URL</span><br></pre></td></tr></table></figure></p>
<p>从post提交的数据看我们需要4个参数’xsrf’,’captcha’,’password’,’phone_num’，所以，我们构建提交的数据字典如下<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">datas</span> = &#123;</span><br><span class="line">        <span class="string">'_xsrf'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'password'</span>: <span class="string">'your_password'</span>,</span><br><span class="line">        <span class="string">'captcha'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'phone_num'</span>: <span class="string">'your_phonenumber'</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="获取验证码"><a href="#获取验证码" class="headerlink" title="获取验证码"></a>获取验证码</h1><p>右键点击验证码，查看源码，看到”img“标签下，src属性存在验证码的网址，鼠标移到src属性上即可查看源网址<br><img src="/images/python模拟登录知乎2.png" alt=""></p>
<p>r 是当前时间的时间戳单位为毫秒，具体获得代码如下：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">time</span> = str(int(time.time() * <span class="number">1000</span>))</span><br><span class="line"><span class="attr">captcha_url</span> = <span class="string">'http://www.zhihu.com/captcha.gif?r='</span> + time + <span class="string">"&amp;type=login"</span></span><br><span class="line"><span class="attr">captcha</span> = s.get(captcha_url)</span><br></pre></td></tr></table></figure></p>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">import time</span><br><span class="line">from PIL import Image</span><br><span class="line"></span><br><span class="line">headers = &#123;'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.96 Safari/537.36'&#125;</span><br><span class="line"></span><br><span class="line">datas = &#123;</span><br><span class="line">        '_xsrf': '',</span><br><span class="line">        'password': 'your_password',</span><br><span class="line">        'captcha': '',</span><br><span class="line">        'phone_num': 'your_phonenumber'</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">login_url = 'https://www.zhihu.com/' <span class="comment"># 登录界面URL</span></span><br><span class="line">post_url = 'https://www.zhihu.com/login/phone_num' <span class="comment"># post请求提交的URL</span></span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">s.headers = headers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取xsrf</span></span><br><span class="line">res1 = s.get(login_url)</span><br><span class="line">pattern = re.compile('&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"_xsrf"</span> value=<span class="string">"(.*?)"</span>/&gt;')</span><br><span class="line">p = pattern.findall(res1.text)</span><br><span class="line">datas['_xsrf'] = p[0]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取验证码</span></span><br><span class="line">time = str(int(time.time() * 1000))</span><br><span class="line">captcha_url = 'http://www.zhihu.com/captcha.gif?r=' + time + <span class="string">"&amp;type=login"</span></span><br><span class="line">captcha = s.get(captcha_url)</span><br><span class="line">with open('captcha.gif', 'wb') as f:</span><br><span class="line">    f.write(captcha.content)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示验证码</span></span><br><span class="line">im = Image.open('captcha.gif')</span><br><span class="line">im.show()</span><br><span class="line">im.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动输入验证码</span></span><br><span class="line">login_captcha = input('input captcha:\n')</span><br><span class="line">datas['captcha'] = login_captcha</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交post请求，并且打印出json</span></span><br><span class="line">result = s.post(post_url, data=datas)</span><br><span class="line">print(result.text)</span><br></pre></td></tr></table></figure>
<h1 id="2017-5-16-完善代码"><a href="#2017-5-16-完善代码" class="headerlink" title="2017.5.16 完善代码"></a>2017.5.16 完善代码</h1><ul>
<li>增加了cookie，登录成功后可以用cookie登录</li>
<li>增加了交互式</li>
<li>完善代码，将代码进行了封装</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">import time</span><br><span class="line">import http.cookiejar</span><br><span class="line">from PIL import Image</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">zhihuSpider</span>(<span class="title">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.headers = &#123;<span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.96 Safari/537.36'</span>&#125;</span><br><span class="line">        <span class="keyword">self</span>.datas = &#123;</span><br><span class="line">            <span class="string">'_xsrf'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'password'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'captcha'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'phone_num'</span>: <span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">self</span>.session = requests.Session()</span><br><span class="line">        <span class="keyword">self</span>.session.headers = <span class="keyword">self</span>.headers</span><br><span class="line">        <span class="keyword">self</span>.session.cookies = http.cookiejar.LWPCookieJar(<span class="string">'cookies'</span>)</span><br><span class="line">        <span class="symbol">try:</span></span><br><span class="line">            <span class="keyword">self</span>.session.cookies.load(<span class="string">'cookies'</span>, ignore_discard=True)</span><br><span class="line">        <span class="symbol">except:</span></span><br><span class="line">            print(<span class="string">'cookies 不能加载'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取xsrf</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_xsrf</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        login_url = <span class="string">'https://www.zhihu.com/'</span> <span class="comment"># 登录界面URL</span></span><br><span class="line">        res = <span class="keyword">self</span>.session.get(login_url)</span><br><span class="line">        pattern = re.compile(<span class="string">'&lt;input type="hidden" name="_xsrf" value="(.*?)"/&gt;'</span>)</span><br><span class="line">        p = pattern.findall(res.text)</span><br><span class="line">        <span class="keyword">self</span>.datas[<span class="string">'_xsrf'</span>] = p[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取验证码</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_captcha</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        t = str(int(time.time() * <span class="number">1000</span>))</span><br><span class="line">        captcha_url = <span class="string">'http://www.zhihu.com/captcha.gif?r='</span> + t + <span class="string">"&amp;type=login"</span></span><br><span class="line">        <span class="comment"># 获取验证码，并将验证码写入captcha.gif</span></span><br><span class="line">        captcha = <span class="keyword">self</span>.session.get(captcha_url)</span><br><span class="line">        with open(<span class="string">'captcha.gif'</span>, <span class="string">'wb'</span>) as <span class="symbol">f:</span></span><br><span class="line">            f.write(captcha.content)</span><br><span class="line">        f.close()</span><br><span class="line">        <span class="comment"># 显示验证码</span></span><br><span class="line">        im = Image.open(<span class="string">'captcha.gif'</span>)</span><br><span class="line">        im.show()</span><br><span class="line">        im.close()</span><br><span class="line">        <span class="comment"># 手动输入验证码</span></span><br><span class="line">        login_captcha = input(<span class="string">'input captcha:\n'</span>)</span><br><span class="line">        <span class="keyword">self</span>.datas[<span class="string">'captcha'</span>] = login_captcha</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">already_login</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        url = <span class="string">'https://www.zhihu.com/settings/profile'</span></span><br><span class="line">        login_code = <span class="keyword">self</span>.session.get(url, allow_redirects=False).status_code</span><br><span class="line">        <span class="keyword">if</span> login_code == <span class="number">200</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">return</span> True</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(<span class="keyword">self</span>, account, password)</span></span><span class="symbol">:</span></span><br><span class="line">        post_url = <span class="string">'https://www.zhihu.com/login/phone_num'</span> <span class="comment"># post请求提交的URL</span></span><br><span class="line">        <span class="comment"># 获取xsrf</span></span><br><span class="line">        <span class="keyword">self</span>.get_xsrf()</span><br><span class="line">        <span class="comment"># 获取验证码</span></span><br><span class="line">        <span class="keyword">self</span>.get_captcha()</span><br><span class="line">        <span class="keyword">self</span>.datas[<span class="string">'phone_num'</span>] = account</span><br><span class="line">        <span class="keyword">self</span>.datas[<span class="string">'password'</span>] = password</span><br><span class="line">        <span class="comment"># 提交post请求，并且打印出json</span></span><br><span class="line">        result = <span class="keyword">self</span>.session.post(post_url, data=<span class="keyword">self</span>.datas)</span><br><span class="line">        print(result.text)</span><br><span class="line">        <span class="keyword">self</span>.session.cookies.save(ignore_discard=True, ignore_expires=True)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">"__main__"</span><span class="symbol">:</span></span><br><span class="line">    spider = zhihuSpider()</span><br><span class="line">    <span class="keyword">if</span> spider.already_login()<span class="symbol">:</span></span><br><span class="line">        print(<span class="string">'用户已经登录'</span>)</span><br><span class="line">    <span class="symbol">else:</span></span><br><span class="line">        account = input(<span class="string">'请输入用户名 \n&gt; '</span>)</span><br><span class="line">        password = input(<span class="string">'请输入密码 \n&gt; '</span>)</span><br><span class="line">        spider.login(account, password)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/05/python-模拟登录pixiv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/05/python-模拟登录pixiv/" itemprop="url">
                  Python爬虫模拟登录pixiv
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-05T14:34:02+08:00">
                2017-05-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python-爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">Python 爬虫</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>记录学习Python模拟登录的过程</p>
<hr>
<h1 id="需要的工具及运行环境"><a href="#需要的工具及运行环境" class="headerlink" title="需要的工具及运行环境"></a>需要的工具及运行环境</h1><ul>
<li>Python 3.6</li>
<li>requests 库</li>
<li>re 库</li>
<li>Chrome 浏览器</li>
</ul>
<hr>
<h1 id="分析URL"><a href="#分析URL" class="headerlink" title="分析URL"></a>分析URL</h1><p>进入<a href="https://www.pixiv.net/" target="_blank" rel="noopener">pixiv官网</a>,<br>按F12 开打开发者工具界面，点击官网上的LOGIN 按钮,<br>跳转到<a href="https://accounts.pixiv.net/login?lang=en&amp;source=pc&amp;view_type=page&amp;ref=wwwtop_accounts_index" target="_blank" rel="noopener">登录界面</a>,<br>开发者工具界面依次选择“Network”-&gt;“Doc”，左侧Name栏有请求信息。<br><img src="/images/python模拟登录pixiv1.png" alt=""><br>如图可知三个重要信息：</p>
<ul>
<li>请求方式:GET</li>
<li>User-Agent</li>
<li>get的请求参数</li>
</ul>
<h2 id="构建请求headers"><a href="#构建请求headers" class="headerlink" title="构建请求headers"></a>构建请求headers</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">headers</span> = &#123;<span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.96 Safari/537.36'</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="构建请求参数"><a href="#构建请求参数" class="headerlink" title="构建请求参数"></a>构建请求参数</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">params</span> =&#123;</span><br><span class="line">        <span class="string">'lang'</span>: <span class="string">'en'</span>,</span><br><span class="line">        <span class="string">'source'</span>: <span class="string">'pc'</span>,</span><br><span class="line">        <span class="string">'view_type'</span>: <span class="string">'page'</span>,</span><br><span class="line">        <span class="string">'ref'</span>: <span class="string">'wwwtop_accounts_index'</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="尝试登录"><a href="#尝试登录" class="headerlink" title="尝试登录"></a>尝试登录</h1><p>开发者界面，勾选Preserve log。<br><img src="/images/python模拟登录pixiv3.png" alt=""></p>
<p>输入账号，密码登录pixiv<br>开发者工具界面点击“XHR” ，左侧name栏选择“login?lang=en”<br><img src="/images/python模拟登录pixiv4.png" alt=""></p>
<p>获得信息：</p>
<ul>
<li>发送表单方法post</li>
<li>表单中要发送的数据</li>
</ul>
<h2 id="构建要发送数据的字典"><a href="#构建要发送数据的字典" class="headerlink" title="构建要发送数据的字典"></a>构建要发送数据的字典</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">datas</span> = &#123;</span><br><span class="line">        <span class="string">'pixiv_id'</span>: <span class="string">'yourEmail@123.com'</span>,</span><br><span class="line">        <span class="string">'password'</span>: <span class="string">'yourpassword'</span>,</span><br><span class="line">        <span class="string">'captcha'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'g_reaptcha_response'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'post_key'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'source'</span>: <span class="string">'pc'</span>,</span><br><span class="line">        <span class="string">'ref'</span>: <span class="string">'wwwtop_accounts_indes'</span>,</span><br><span class="line">        <span class="string">'return_to'</span>: <span class="string">'https://www.pixiv.net/'</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>注意到字典中有一个key 为post_key，这个东西你每次登录之前会给你个唯一值，所以我们要获得这个值，并将赋值给post_key的value。<br>进入<a href="https://accounts.pixiv.net/login?lang=en&amp;source=pc&amp;view_type=page&amp;ref=wwwtop_accounts_index" target="_blank" rel="noopener">登录界面</a>，F12进入开发者工具界面，选择Elements，ctrl+F 搜索”form”标签<br><img src="/images/python模拟登录pixiv2.png" alt=""></p>
<h2 id="建立匹配规则"><a href="#建立匹配规则" class="headerlink" title="建立匹配规则"></a>建立匹配规则</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pattern = re.compile(<span class="string">r'name="post_key" value="(.*?)"&gt;'</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># -*- coding=utf-8 -*-</span></span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">headers = &#123;'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.<span class="number">3029.96</span> Safari/537.36'&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># get提交参数</span></span><br><span class="line">params =&#123;</span><br><span class="line">        'lang': 'en',</span><br><span class="line">        'source': 'pc',</span><br><span class="line">        'view_type': 'page',</span><br><span class="line">        'ref': 'wwwtop_accounts_index'</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># post提交参数</span></span><br><span class="line">datas = &#123;</span><br><span class="line">        'pixiv_id': 'yourEmail@123.com',</span><br><span class="line">        'password': 'yourpassword,</span><br><span class="line">        'captcha': '',</span><br><span class="line">        'g_reaptcha_response': '',</span><br><span class="line">        'post_key': '',</span><br><span class="line">        'source': 'pc',</span><br><span class="line">        'ref': 'wwwtop_accounts_indes',</span><br><span class="line">        'return_to': 'https:<span class="comment">//www.pixiv.net/'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">login_url = 'https://accounts.pixiv.net/login' <span class="meta"># 登陆的URL</span></span><br><span class="line">post_url = 'https://accounts.pixiv.net/api/login?lang=en' <span class="meta"># 提交POST请求的URL</span></span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">s.headers = headers</span><br><span class="line"></span><br><span class="line"><span class="meta"># 获取登录页面</span></span><br><span class="line">res = s.get(login_url, params=params)</span><br><span class="line"></span><br><span class="line"><span class="meta"># 获取post_key</span></span><br><span class="line">pattern = re.compile(r'name="post_key" value="(.*?)"&gt;')</span><br><span class="line">r = pattern.findall(res.text)</span><br><span class="line">datas['post_key'] = r[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta"># 模拟登录</span></span><br><span class="line">result = s.post(post_url, data=datas)</span><br><span class="line"></span><br><span class="line"><span class="meta"># 打印出json信息</span></span><br><span class="line">print(result.json())</span><br></pre></td></tr></table></figure>
<h1 id="2017-5-16-完善代码"><a href="#2017-5-16-完善代码" class="headerlink" title="2017.5.16 完善代码"></a>2017.5.16 完善代码</h1><ul>
<li>学习了cookie的使用，若第一次登陆成功，下次登录后就可以使用cookie登录了。</li>
<li>将完整的代码进行了封装。</li>
<li>增加了交互式<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> http.cookiejar</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PixivSpider</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.session = requests.Session()</span><br><span class="line">        self.headers = &#123;<span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.96 Safari/537.36'</span>&#125;</span><br><span class="line">        self.session.headers = self.headers</span><br><span class="line">        self.session.cookies = http.cookiejar.LWPCookieJar(filename=<span class="string">'cookies'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 加载cookie</span></span><br><span class="line">            self.session.cookies.load(filename=<span class="string">'cookies'</span>, ignore_discard=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">'cookies不能加载'</span>)</span><br><span class="line"></span><br><span class="line">        self.params =&#123;</span><br><span class="line">            <span class="string">'lang'</span>: <span class="string">'en'</span>,</span><br><span class="line">            <span class="string">'source'</span>: <span class="string">'pc'</span>,</span><br><span class="line">            <span class="string">'view_type'</span>: <span class="string">'page'</span>,</span><br><span class="line">            <span class="string">'ref'</span>: <span class="string">'wwwtop_accounts_index'</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.datas = &#123;</span><br><span class="line">            <span class="string">'pixiv_id'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'password'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'captcha'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'g_reaptcha_response'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'post_key'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'source'</span>: <span class="string">'pc'</span>,</span><br><span class="line">            <span class="string">'ref'</span>: <span class="string">'wwwtop_accounts_indes'</span>,</span><br><span class="line">            <span class="string">'return_to'</span>: <span class="string">'https://www.pixiv.net/'</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_postkey</span><span class="params">(self)</span>:</span></span><br><span class="line">        login_url = <span class="string">'https://accounts.pixiv.net/login'</span> <span class="comment"># 登陆的URL</span></span><br><span class="line">        <span class="comment"># 获取登录页面</span></span><br><span class="line">        res = self.session.get(login_url, params=self.params)</span><br><span class="line">        <span class="comment"># 获取post_key</span></span><br><span class="line">        pattern = re.compile(<span class="string">r'name="post_key" value="(.*?)"&gt;'</span>)</span><br><span class="line">        r = pattern.findall(res.text)</span><br><span class="line">        self.datas[<span class="string">'post_key'</span>] = r[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">already_login</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 请求用户配置界面，来判断是否登录</span></span><br><span class="line">        url = <span class="string">'https://www.pixiv.net/setting_user.php'</span></span><br><span class="line">        login_code = self.session.get(url, allow_redirects=<span class="keyword">False</span>).status_code</span><br><span class="line">        <span class="keyword">if</span> login_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self, account, password)</span>:</span></span><br><span class="line">        post_url = <span class="string">'https://accounts.pixiv.net/api/login?lang=en'</span> <span class="comment"># 提交POST请求的URL</span></span><br><span class="line">        <span class="comment"># 设置postkey</span></span><br><span class="line">        self.get_postkey()</span><br><span class="line">        self.datas[<span class="string">'pixiv_id'</span>] = account</span><br><span class="line">        self.datas[<span class="string">'password'</span>] = password</span><br><span class="line">        <span class="comment"># 发送post请求模拟登录</span></span><br><span class="line">        result = self.session.post(post_url, data=self.datas)</span><br><span class="line">        print(result.json())</span><br><span class="line">        <span class="comment"># 储存cookies</span></span><br><span class="line">        self.session.cookies.save(ignore_discard=<span class="keyword">True</span>, ignore_expires=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    spider = PixivSpider()</span><br><span class="line">    <span class="keyword">if</span> spider.already_login():</span><br><span class="line">        print(<span class="string">'用户已经登录'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        account = input(<span class="string">'请输入用户名\n&gt; '</span>)</span><br><span class="line">        password = input(<span class="string">'请输入密码\n&gt; '</span>)</span><br><span class="line">        spider.login(account, password)</span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/03/python爬虫爬取暴走漫画官网GIF图/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/03/python爬虫爬取暴走漫画官网GIF图/" itemprop="url">
                  Python爬虫爬取暴走漫画官网GIF图
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-03T08:16:13+08:00">
                2017-05-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python-爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">Python 爬虫</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="爬取需要工具及运行环境"><a href="#爬取需要工具及运行环境" class="headerlink" title="爬取需要工具及运行环境"></a>爬取需要工具及运行环境</h1><ul>
<li>Python3.6</li>
<li>BeautifulSoup4 库</li>
<li>urllib.request 库</li>
<li>Chrome 浏览器</li>
</ul>
<hr>
<h1 id="分析需要解析的的URL"><a href="#分析需要解析的的URL" class="headerlink" title="分析需要解析的的URL"></a>分析需要解析的的URL</h1><ul>
<li>进入暴走漫画官网，进入“趣图-GIF怪兽首页”，可获取URL信息为”<a href="http://baozoumanhua.com/catalogs/gif" target="_blank" rel="noopener">http://baozoumanhua.com/catalogs/gif</a>“<br>点击下一页获取URL信息为“<a href="http://baozoumanhua.com/catalogs/gif?page=2&amp;sv=1493773501”" target="_blank" rel="noopener">http://baozoumanhua.com/catalogs/gif?page=2&amp;sv=1493773501”</a><br>找到规律，只改变 page=2 这个数字就行<br>2017.5.4<br><del><strong>注意“sv=1493773501”这个数值可能会变,不同时请做相应修改</strong></del><br>url不加”sv=1493773501”也可以跳转</li>
</ul>
<h2 id="请求代码"><a href="#请求代码" class="headerlink" title="请求代码"></a>请求代码</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urls = <span class="keyword">set</span>() # 建立储存需要爬取的<span class="keyword">URL</span>集合</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> rang(<span class="number">1</span>, <span class="number">3</span>):</span><br><span class="line">    <span class="keyword">url</span> = <span class="string">'http://baozoumanhua.com/catalogs/gif?page='</span> + <span class="keyword">str</span>(i) # 获取<span class="keyword">URL</span></span><br><span class="line">    urls.add(<span class="keyword">url</span>) # 将<span class="keyword">URL</span>添加到待爬取的<span class="keyword">URL</span>集合中</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="分析图片规律"><a href="#分析图片规律" class="headerlink" title="分析图片规律"></a>分析图片规律</h1><ul>
<li>右键需要爬取的图片，点击“检查”，发现动图分为两种，一种是标签”video“中的 “data-original-image-url”属性存放图片的URL连接，还有一种是“img”标签下的“data-original-image-url”属性存放图片URL连接</li>
</ul>
<h2 id="解析的代码"><a href="#解析的代码" class="headerlink" title="解析的代码"></a>解析的代码</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">res_data = [] <span class="comment"># 存放图片的URL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟浏览器</span></span><br><span class="line">user_agent = <span class="string">'Mozilla/5.0 (X11; linux x86_64) AppleWebKit/537.36'</span></span><br><span class="line">headers = &#123;<span class="string">'User-Agent'</span>: user_agent&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从URL集合中取出一个URL，进行请求解析</span></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> <span class="symbol">urls:</span></span><br><span class="line">    <span class="comment"># 下载页面</span></span><br><span class="line">    req = urllib.request.Request(url, headers = headers)</span><br><span class="line">    response = urllib.request.urlopen(req)</span><br><span class="line">    html = response.read().decode(<span class="string">'utf-8'</span>) <span class="comment"># 将代码格式化为UTF-8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用beautifulsoup 对 html 进行解析</span></span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">'html.parse'</span>)</span><br><span class="line">    gif1s = soup.findAll(<span class="string">'video'</span>，<span class="keyword">class</span><span class="number">_</span>=<span class="string">"lazy"</span>) <span class="comment"># 获取相关的&lt;video&gt; 标签信息</span></span><br><span class="line">	gif2s = soup.findAll(<span class="string">'img'</span>, <span class="keyword">class</span><span class="number">_</span><span class="string">"lazy"</span>) <span class="comment"># 获取相关&lt;img&gt; 标签信息</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将图片的URL 存放到res_data列表中</span></span><br><span class="line">    res_data += [gif[<span class="string">'data-original-image-url'</span>] <span class="keyword">for</span> gif <span class="keyword">in</span> gif1s]</span><br><span class="line">    res_data += [gif[<span class="string">'data-original-image-url'</span>] <span class="keyword">for</span> gif <span class="keyword">in</span> gif2s]</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="下载图片"><a href="#下载图片" class="headerlink" title="下载图片"></a>下载图片</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> range(len(res_data)):</span><br><span class="line">    filename = str(i) + <span class="string">'.gif'</span></span><br><span class="line">    urllib<span class="selector-class">.request</span><span class="selector-class">.urlretrieve</span>(res_data[i], <span class="string">'../bzmh/download_gif/'</span> + filename)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import urllib.request</span><br><span class="line"><span class="keyword">from</span> bs4 import BeautifulSoup</span><br><span class="line"></span><br><span class="line">urls = <span class="keyword">set</span>() <span class="meta"># 存放待爬取的URL集合</span></span><br><span class="line">res_data = [] <span class="meta"># 存放已经爬取的图片URL列表</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 指定需要爬取的页面数, 并加入到URL集合中</span></span><br><span class="line"><span class="function"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="title">range</span>(<span class="params"><span class="number">1</span>, <span class="number">3</span></span>):</span></span><br><span class="line"><span class="function">    url </span>= <span class="string">'http://baozoumanhua.com/catalogs/gif?page='</span> + str(i)</span><br><span class="line">    urls.<span class="keyword">add</span>(url)</span><br><span class="line"></span><br><span class="line"><span class="meta"># 模拟浏览器</span></span><br><span class="line">user_agent = <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'</span></span><br><span class="line">headers = &#123;<span class="string">'User-Agent'</span>: user_agent&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># 从URL集合中取出一个URL进行解析</span></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    req = urllib.request.Request(url, headers=headers)</span><br><span class="line">    response = urllib.request.urlopen(req)</span><br><span class="line">    html = response.read().decode(<span class="string">'utf-8'</span>) <span class="meta"># 格式化编码为UTF-8</span></span><br><span class="line">    <span class="meta"># 对HTML页面进行解析</span></span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">'html.parser'</span>)</span><br><span class="line">    gif1s = soup.findAll(<span class="string">'video'</span>, style=<span class="string">'width: 500px; height: 500px;'</span>) <span class="meta"># 获取相关“video” 标签的信息</span></span><br><span class="line">    gif2s = soup.findAll(<span class="string">'img'</span>, class_=<span class="string">'lazy'</span>) <span class="meta"># 获取相关“img” 标签的信息</span></span><br><span class="line">    <span class="meta"># 将图片的URL存放到图片URL列表中</span></span><br><span class="line">    res_data += [gif[<span class="string">'data-original-image-url'</span>]<span class="keyword">for</span> gif <span class="keyword">in</span> gif1s]</span><br><span class="line">    res_data += [gif[<span class="string">'data-original-image-url'</span>]<span class="keyword">for</span> gif <span class="keyword">in</span> gif2s]</span><br><span class="line"></span><br><span class="line"><span class="meta"># 下载图片</span></span><br><span class="line"><span class="function"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="title">range</span>(<span class="params">len(res_data</span>)):</span></span><br><span class="line"><span class="function">    filename </span>= str(i) + <span class="string">".gif"</span></span><br><span class="line">    urllib.request.urlretrieve(res_data[i], <span class="string">'../bzmh/download_gif/'</span> + filename)</span><br></pre></td></tr></table></figure>
<p>2017.5.4<br>完善代码增加交互式<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">urls = set() <span class="comment"># 存放需要爬取的URL集合</span></span><br><span class="line">res_data = [] <span class="comment"># 存放需要爬取的图片的URL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得要爬取的范围</span></span><br><span class="line">print(<span class="string">'请输入要爬取的页面范围\n例：输入1 2，则爬取第1页和第2页的图片'</span>)</span><br><span class="line">print(<span class="string">'请输入首页'</span>)</span><br><span class="line">front_page = input()</span><br><span class="line">print(<span class="string">'请输入尾页'</span>)</span><br><span class="line">back_page = input()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取需要爬取的URL</span></span><br><span class="line"><span class="keyword">if</span> front_page == back_page:</span><br><span class="line">    url = <span class="string">'http://baozoumanhua.com/catalogs/gif?page='</span> + front_page</span><br><span class="line">    urls.add(url)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(front_page), int(back_page)+<span class="number">1</span>):</span><br><span class="line">        url = <span class="string">'http://baozoumanhua.com/catalogs/gif?page='</span> + str(i)</span><br><span class="line">        urls.add(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟浏览器</span></span><br><span class="line">user_agent = <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'</span></span><br><span class="line">headers = &#123;<span class="string">'User-Agent'</span>: user_agent&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从URL集合中，取出一个URL进行解析</span></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    req = urllib.request.Request(url, headers=headers) <span class="comment"># 请求页面</span></span><br><span class="line">    response = urllib.request.urlopen(req) <span class="comment"># 下载页面</span></span><br><span class="line">    html = response.read().decode(<span class="string">'utf-8'</span>) <span class="comment"># 编码格式化为UTF-8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解析页面</span></span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">'html.parser'</span>)</span><br><span class="line">    gif1s = soup.findAll(<span class="string">'video'</span>, style=<span class="string">'width: 500px; height: 500px;'</span>)</span><br><span class="line">    gif2s = soup.findAll(<span class="string">'img'</span>, class_=<span class="string">'lazy'</span>)</span><br><span class="line">    res_data += [gif[<span class="string">'data-original-image-url'</span>]<span class="keyword">for</span> gif <span class="keyword">in</span> gif1s]</span><br><span class="line">    res_data += [gif[<span class="string">'data-original-image-url'</span>]<span class="keyword">for</span> gif <span class="keyword">in</span> gif2s]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在当前目录下，建立存储gif图片的文件夹</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'./download_gif'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'download_gif'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载图片</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(res_data)):</span><br><span class="line">    filename = str(i) + <span class="string">".gif"</span></span><br><span class="line">    urllib.request.urlretrieve(res_data[i], <span class="string">'./download_gif/'</span> + filename)</span><br></pre></td></tr></table></figure></p>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/02/python-爬虫爬取暴走漫画官网-jpg图片/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="The One">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nameless">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/02/python-爬虫爬取暴走漫画官网-jpg图片/" itemprop="url">
                  Python 爬虫爬取暴走漫画官网 jpg图片
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-02T15:13:27+08:00">
                2017-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python-爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">Python 爬虫</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="爬取需要工具及运行环境"><a href="#爬取需要工具及运行环境" class="headerlink" title="爬取需要工具及运行环境"></a>爬取需要工具及运行环境</h1><ul>
<li>Python3.6</li>
<li>BeautifulSoup4 库</li>
<li>urllib.request 库</li>
<li>Chrome 浏览器</li>
</ul>
<hr>
<h1 id="分析需要解析的的URL"><a href="#分析需要解析的的URL" class="headerlink" title="分析需要解析的的URL"></a>分析需要解析的的URL</h1><ul>
<li>进入暴走漫画官网，进入“趣图-JPG杂烩首页”，可获取URL信息为”<a href="http://baozoumanhua.com/catalogs/jpg" target="_blank" rel="noopener">http://baozoumanhua.com/catalogs/jpg</a>“<br>点击下一页获取URL信息为“<a href="http://baozoumanhua.com/catalogs/jpg?page=2&amp;sv=1493709301”" target="_blank" rel="noopener">http://baozoumanhua.com/catalogs/jpg?page=2&amp;sv=1493709301”</a><br>找到规律，只改变 page=2 这个数字就行<br>2017.5.4<br><del><strong>注意“sv=149379301”这个数值可能会变,不同时请做相应修改</strong></del><br>url去掉sv=1493709301 也可以跳转<h2 id="请求代码"><a href="#请求代码" class="headerlink" title="请求代码"></a>请求代码</h2></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urls = <span class="keyword">set</span>() # 建立储存需要爬取的<span class="keyword">URL</span>集合</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> rang(<span class="number">1</span>, <span class="number">3</span>):</span><br><span class="line">    <span class="keyword">url</span> = <span class="string">'http://baozoumanhua.com/catalogs/jpg?page='</span> + <span class="keyword">str</span>(i) # 获取<span class="keyword">URL</span></span><br><span class="line">    urls.add(<span class="keyword">url</span>) # 将<span class="keyword">URL</span>添加到待爬取的<span class="keyword">URL</span>集合中</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="分析图片规律"><a href="#分析图片规律" class="headerlink" title="分析图片规律"></a>分析图片规律</h1><ul>
<li>右键需要爬取的图片，点击“检查”，发现标签”img“中的 “data-original”属性存放图片的URL连接</li>
</ul>
<h2 id="解析的代码"><a href="#解析的代码" class="headerlink" title="解析的代码"></a>解析的代码</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">res_data = [] <span class="comment"># 存放图片的URL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟浏览器</span></span><br><span class="line">user_agent = <span class="string">'Mozilla/5.0 (X11; linux x86_64) AppleWebKit/537.36'</span></span><br><span class="line">headers = &#123;<span class="string">'User-Agent'</span>: user_agent&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从URL集合中取出一个URL，进行请求解析</span></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> <span class="symbol">urls:</span></span><br><span class="line">    <span class="comment"># 下载页面</span></span><br><span class="line">    req = urllib.request.Request(url, headers = headers)</span><br><span class="line">    response = urllib.request.urlopen(req)</span><br><span class="line">    html = response.read().decode(<span class="string">'utf-8'</span>) <span class="comment"># 将代码格式化为UTF-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用beautifulsoup 对 html 进行解析</span></span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">'html.parse'</span>)</span><br><span class="line">    imgs = soup.findAll(<span class="string">'img'</span>，<span class="keyword">class</span><span class="number">_</span>=<span class="string">"lazy"</span>) <span class="comment"># 获取所有的&lt;img&gt; 标签信息</span></span><br><span class="line">    res_data += [img[<span class="string">'data-original'</span>] <span class="keyword">for</span> img <span class="keyword">in</span> imgs] <span class="comment"># 将图片的URL 存放到res_data列表中</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="下载图片"><a href="#下载图片" class="headerlink" title="下载图片"></a>下载图片</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> range(len(res_data)):</span><br><span class="line">    filename = str(i) + <span class="string">'.jpg'</span></span><br><span class="line">	urllib<span class="selector-class">.request</span><span class="selector-class">.urlretrieve</span>(res_data[i], <span class="string">'../bzmh/download_jpg/'</span> + filename)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># -*- coding:utf-8 -*-</span></span><br><span class="line">import urllib.request</span><br><span class="line"><span class="keyword">from</span> bs4 import BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="meta"># 目标URL</span></span><br><span class="line">urls = <span class="keyword">set</span>() <span class="meta"># 存放需要爬取的URL</span></span><br><span class="line">res_data = [] <span class="meta"># 存放图片的URL</span></span><br><span class="line"><span class="function"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="title">range</span>(<span class="params"><span class="number">1</span>, <span class="number">3</span></span>):</span></span><br><span class="line"><span class="function">    url </span>= <span class="string">'http://baozoumanhua.com/catalogs/jpg?page='</span> + str(i)</span><br><span class="line">    urls.<span class="keyword">add</span>(url)</span><br><span class="line"></span><br><span class="line"><span class="meta"># 模拟浏览器</span></span><br><span class="line">user_agent = <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'</span></span><br><span class="line">headers = &#123;<span class="string">'User-Agent'</span>: user_agent&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># 从URL集合中获得一个URL进行解析</span></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    req = urllib.request.Request(url, headers=headers)</span><br><span class="line">    <span class="meta"># 下载页面</span></span><br><span class="line">    response = urllib.request.urlopen(req)</span><br><span class="line">    html = response.read().decode(<span class="string">'utf-8'</span>)  <span class="meta"># 代码格式UTF-8</span></span><br><span class="line">    <span class="meta"># 解析网页</span></span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">'html.parser'</span>)</span><br><span class="line">    imgs = soup.findAll(<span class="string">'img'</span>, class_=<span class="string">"lazy"</span>) <span class="meta"># 获取所有的&lt;img&gt; 标签信息</span></span><br><span class="line">    res_data += [img[<span class="string">'data-original'</span>]<span class="keyword">for</span> img <span class="keyword">in</span> imgs] <span class="meta"># 将图片的URL 存放到res_data列表中</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 下载图片</span></span><br><span class="line"><span class="function"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="title">range</span>(<span class="params">len(res_data</span>)):</span></span><br><span class="line"><span class="function">    filename </span>= str(i) + <span class="string">".jpg"</span></span><br><span class="line">    urllib.request.urlretrieve(res_data[i], <span class="string">'../bzmh/download_jpg/'</span> + filename)  <span class="meta"># 下载图片内容</span></span><br></pre></td></tr></table></figure>
<p>2017.5.4<br>完善代码增加了交互式<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">urls = set() <span class="comment"># 存放需要爬取URL集合</span></span><br><span class="line">res_data = [] <span class="comment"># 存放需要爬取图片的URL集合</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得要爬取的范围</span></span><br><span class="line">print(<span class="string">'请输入要爬取的页面范围\n例：输入1 2，则爬取第1页和第2页的图片'</span>)</span><br><span class="line">print(<span class="string">'请输入首页'</span>)</span><br><span class="line">front_page = input()</span><br><span class="line">print(<span class="string">'请输入尾页'</span>)</span><br><span class="line">back_page = input()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得URL</span></span><br><span class="line"><span class="keyword">if</span> front_page == back_page:</span><br><span class="line">    url = <span class="string">'http://baozoumanhua.com/catalogs/jpg?page='</span> + front_page</span><br><span class="line">    urls.add(url)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(front_page), int(back_page)+<span class="number">1</span>):</span><br><span class="line">        url = <span class="string">'http://baozoumanhua.com/catalogs/jpg?page='</span> + str(i)</span><br><span class="line">        urls.add(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟浏览器</span></span><br><span class="line">user_agent = <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'</span></span><br><span class="line">headers = &#123;<span class="string">'User-Agent'</span>: user_agent&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从带爬取的URL集合中，取出一个URL</span></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    req = urllib.request.Request(url, headers=headers) <span class="comment"># 请求页面</span></span><br><span class="line">    response = urllib.request.urlopen(req) <span class="comment"># 下载页面</span></span><br><span class="line">    html = response.read().decode(<span class="string">'utf-8'</span>)  <span class="comment"># 代码格式UTF-8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解析网页</span></span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">'html.parser'</span>)</span><br><span class="line">    imgs = soup.findAll(<span class="string">'img'</span>, class_=<span class="string">"lazy"</span>)</span><br><span class="line">    res_data += [img[<span class="string">'data-original'</span>]<span class="keyword">for</span> img <span class="keyword">in</span> imgs]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为当前目录建立个文件夹，用于储存图片</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'./download_jpg/'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'download_jpg'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载图片，并保存到download_jpg 文件夹中</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(res_data)):</span><br><span class="line">    filename = str(i) + <span class="string">".jpg"</span></span><br><span class="line">    urllib.request.urlretrieve(res_data[i], <span class="string">'./download_jpg/'</span> + filename)  <span class="comment"># 下载图片内容</span></span><br></pre></td></tr></table></figure></p>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="The One" />
          <p class="site-author-name" itemprop="name">The One</p>
           
              <p class="site-description motion-element" itemprop="description">your life. your learning. your way.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">The One</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="true"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  

  


  
  
  
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  

</body>
</html>
